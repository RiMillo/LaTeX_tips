%! TEX root = ex_plot.tex

\documentclass[a4paper,11pt]{article}

\usepackage[centering,scale=0.9]{geometry}

\usepackage[svgnames,table]{xcolor} % Possibly useless here

\usepackage{tikz} % useless, since pgfplots already loads it
\usetikzlibrary{calc} % It allows to make arithmetic operations with TiKz nodes.
\usetikzlibrary{spy} % Spy / zoom / magnifying tools 
\usepackage{pgfplots} % useless, since pgfplotstable already loads it
\usepackage{pgfplotstable}
\usepgflibrary{plotmarks} % Extended use of plot markers
\pgfplotsset{compat=newest,
width=11cm,
% Plot canvas style
graph/.style={grid=major, major grid style=dotted},
% Plot style
%forcsv/.style={col sep=comma}, % If comma-separated values
ana/.style={thin,color=black,mark=none},
gridone/.style={thick,color=blue,mark=square},
gridtwo/.style={thick,color=red,mark=diamond},
gridthree/.style={thick,color=green,mark=triangle},
every n index/.style={
  each nth point=#1,% This should be enough: the following two lines discard the warnings
  filter discard warning=false,
  unbounded coords=jump
},
} % pgfplotsset

% For the fancy colorful table
\usepackage{booktabs}
\xdefinecolor{blue-rule}{RGB}{0,26,112}
\xdefinecolor{blue-table-bg}{RGB}{194 214 241}
\setlength\arrayrulewidth{2.2pt}%
\arrayrulecolor{blue-rule}
%% Odd columns
\newcolumntype{O}{>{\columncolor{white}}c}%
%% Even columns
\newcolumntype{E}{>{\columncolor{blue-table-bg}}c}%
%% Vertical spacing
\renewcommand{\arraystretch}{1.2}
%% Horizontal spacing
\setlength{\tabcolsep}{25pt}
% New environment for rounded tables
\usepackage{environ}
\NewEnviron{roundtable}[1]{%
    \noindent%
    \begin{tikzpicture}[line width=.1mm,rounded corners=.5em]
      \node[clip,inner sep=.5\pgflinewidth] (table) {%
        \begin{tabular}{#1}
          \BODY%
        \end{tabular}%
      };
    \end{tikzpicture}%
  }

% Method one: read and store
\pgfplotstableread{grid1.dat}\gridone

\begin{document}
  \begin{tikzpicture}
    \begin{scope}[spy using outlines,connect spies]
      \begin{axis}[name=graph_one,%
        graph,title={Title $\alpha$},xlabel={\large Time [s]},ylabel={\small Interface position [mm]},legend,legend pos=south east%
        ]
        \addplot[ana] table[x index=0,y index=1] {analytical.dat};
      
        % Method one: read and store - follows
        %\addplot[gridone,every n index=20] table[x index=0,y index=1] {\gridone};
        % ...If columns have names
        %\addplot[gridone,every n index=20] table[x=xname,y=yname] {\gridone};
        % ...Filter marks, not data point
        \addplot[gridone,mark repeat=20] table[x index=0,y index=1] {\gridone};\label{grp:gr1}
        % Method two: read, plot, discard
        \addplot[gridtwo,every n index=20] table[x index=0,y index=1] {grid2.dat};
        \addplot[gridthree,every n index=20] table[x index=0,y index=1] {grid3.dat};
        \legend{analytical,Grid 1,Grid 2,Grid 3}
        % Operation with data
        \addplot[gridone,every n index=20,dashed,mark options={solid}] table[x index=0,y expr={\thisrowno{1}/3}] {\gridone};
        \addlegendentry{Grid 1 bis}
        \addplot[gridtwo,every n index=20,dotted,mark options={solid}] table[x index=0,y expr={\thisrowno{1}/3+1e-4}] {grid2.dat};
        \addplot[gridthree,every n index=20,dashdotted,mark options={solid}] table[x index=0,y expr={\thisrowno{1}/3+2e-4}] {grid3.dat};
        \coordinate (tospy)    at (4,2.1e-4);
        \coordinate (location) at (10,8e-4);
      \end{axis}
      \spy [magnification=3,size=2cm,circle] on (tospy) in node at (location);
    \end{scope}
  \end{tikzpicture}

  You can even do this: \ref{grp:gr1} grid one.

  \begin{tikzpicture}
    \begin{scope}[spy using outlines,connect spies]
      \begin{loglogaxis}[name=gt,graph]
        \addplot expression[domain=1e1:1e5] {10*x^(-1/3)} node[above,sloped,pos=0.9] (inside) {$1^{st}$ order};
      \end{loglogaxis}
      \coordinate (outside) at ($(gt.south east)+(2,0)$);
      \spy[magnification=2,size=3cm,rectangle] on (inside) in node at (outside);
    \end{scope}
  \end{tikzpicture}

  And now, a table.

  % The following definitions may be put inside the square brackets in the pgfplotstabletypeset, but here are globally defined, hence re-usable
  \pgfplotstableset{%
    datastyle/.style={sci,sci zerofill=true,precision=3,},
    columns/mesh/.style={column name={},string type,column type={c|}},
    columns/cenhho/.style={column name={$a_{h}^{c}$},datastyle,column type={c}},
    columns/cencdo/.style={column name={$a_{c}^{c}$},datastyle,column type={c|}},
    columns/upwhho/.style={column name={$a_{h}^{u}$},datastyle,column type={c}},
    columns/upwcdo/.style={column name={$a_{c}^{u}$},datastyle,column type={c}},
  }
  \begin{center}
  \pgfplotstabletypeset[%
    columns={mesh,cenhho,cencdo,upwhho,upwcdo},
    every head row/.append style={after row=\hline,before row={ Mesh & \multicolumn{2}{c|}{Centered} & \multicolumn{2}{c}{Upwind}\\}},
    ]
  {mesh  cenhho       cencdo      upwhho      upwcdo
   H4    3.18574e-01  3.18574e-01 3.20767e-01 3.19698e-01 
   H8    1.04893e-01  1.04893e-01 1.07353e-01 1.06905e-01 
   H16   2.81905e-02  2.81905e-02 2.99132e-02 2.97545e-02 
   H32   7.17828e-03  7.17828e-03 8.24024e-03 8.18674e-03 
   H64   1.80288e-03  1.80056e-03 2.45854e-03 2.43920e-03
  }
  \end{center}

  Creating columns, computing orders of convergence, sorting, some styles,\ldots all in the following example.
  \pgfplotstableread{%
    err         dofs
    2.5e-1      4
    1           1
    1.5645e-2   64
    6.15e-2     16
  }\testing
  \pgfplotstablecreatecol[create col/dyadic refinement rate={dofs}]{refdofs}{\testing}
  \pgfplotstablecreatecol[create col/dyadic refinement rate={err}]{referr}{\testing}
  \begin{center}
    \pgfplotstabletypeset[%
      columns={err,dofs,ord},
      every head row/.style={after row={\hline}},
      sort,sort key={dofs},
      columns/err/.style={column name={Errors},sci,sci zerofill=true,precision=6,dec sep align},
      columns/dofs/.style={column name={\#DoFs},column type={c|},int detect},
      % Separate creation and style definition
      create on use/ord/.style={create col/expr={-2*\thisrow{referr}/\thisrow{refdofs}}},
      columns/ord/.style={column name={Order cvg (2D)},precision=2,fixed zerofill},
      ]{\testing}
  \end{center}

  What about some textual plot?\\
  \noindent Here you are!
  \newcommand{\axisfontsize}{\normalsize}
  \newcommand{\tickfontsize}{\footnotesize}

  \def\xShift{-2.5cm}
  \def\yShift{-1.7cm}

  \begin{tikzpicture}
    \begin{axis}
      [
      name=mg,
      % Dimension and scaling
      xmin=0,xmax=1.1,ymin=0,ymax=1.1,
      unit vector ratio=3 2,
      % Axis and labels
      axis lines*=center,
      % % x
      xlabel={$u$-$p$ coupling},
      xlabel style={font=\axisfontsize,at={(ticklabel cs:1)},anchor=east,yshift=-4pt},
      % % x
      ylabel={Nonlinearity},
      ylabel style={font=\axisfontsize,at={(ticklabel cs:1)},anchor=east},
      % Ticks
      % % x
      xtick={0.15,0.7,1},
      xticklabels={AC\\1 step,AC\\$n$ step,Monolithic},
      xticklabel style={font=\tickfontsize,align=center},
      % % x
      ytick={0.10,0.3,0.8,1},
      yticklabel style={font=\tickfontsize,align=right},
      yticklabels={Explicit\\advection,Picard\\1 step,Picard\\(converged),Newton},
      %
      after end axis/.code={
         \draw (rel axis cs:0,0.4) +(-2mm,-1mm) -- +(2mm,1mm)
              ++(0pt,-1mm)
              +(-2mm,-1mm) -- +(2mm,1mm)
              (rel axis cs:0.4,0) +(-1mm,-2mm) -- +(1mm,2mm)
              ++(-1mm,0pt)
              +(-1mm,-2mm) -- +(1mm,2mm)
              ;
         }
      ]
      \newcommand{\ptAC}{(0.15,0.1)}
      \newcommand{\ptFC}{(1,0.8)}
      \newcommand{\ptIn}{(1,0.1)}
      \pgfplotsinvokeforeach{xcomb,ycomb}{
        \addplot[densely dotted,very thick,opacity=0.2,#1] coordinates {\ptAC};
        \addplot[densely dotted,very thick,opacity=0.2,#1] coordinates {\ptFC};
        \addplot[densely dotted,very thick,opacity=0.2,#1] coordinates {\ptIn};
      }
      \draw[black,fill=white] \ptAC circle (0.1cm);
      \node[pin=above:{AC-based}] at \ptAC {};
      %\addplot[densely dotted,very thick,opacity=0.2,xcomb] coordinates {(0.15,0.1)};
      %\node [fill=blue,above,font=\tickfontsize] at (0.15,0.1) {AC-based};
      \draw[fill=black] \ptFC circle (0.1cm);
      \node[pin=above left:{Fully coupled}] at \ptFC {};
      %\node [fill=black,] at (1,1) {};
      \draw[fill=gray] \ptIn circle (0.1cm);
      \node[pin=above left:{Intermediate}] at \ptIn {};
      
    \end{axis}
    \draw[<-|] ([xshift=\xShift]mg.north west) node [rotate=90,below,font=\tickfontsize] {expensive}
              --                              node [midway,rotate=90,below,font=\axisfontsize] {cost}
              ([xshift=\xShift]mg.south west) node [rotate=90,below,font=\tickfontsize] {cheap};
    \draw[<-|] ([yshift=\yShift]mg.south east) node [above,font=\tickfontsize] {expensive}
              --                              node [midway,above,font=\axisfontsize] {cost}
              ([yshift=\yShift]mg.south west) node [above,font=\tickfontsize] {cheap};
    \node [below,font=\tickfontsize] at ([yshift=\yShift]mg.south west) {approximated};
    \node [below,font=\axisfontsize] at ([yshift=\yShift]mg.south) {incompressibility constraint};
    \node [below,font=\tickfontsize] at ([yshift=\yShift]mg.south east) {accurate};
  \end{tikzpicture}

  And now a fancy colorful table (in order to have a float, put it inside a \texttt{table} environment)\\
  \begin{roundtable}{O|E|O|E}
   \rowcolor{blue-rule}% 
      {\color{white}Puissance nominale} & {\color{white}Surface rotor} & {\color{white}Type} & {\color{white}Production annuelle}\\
    \hline
    1 kW & 7 m$^2$ & vertical & 1000 kWh \\
    \hline
    1 kW & 7 m$^2$ & vertical & 1000 kWh \\
    \hline
    1 kW & 7 m$^2$ & vertical & 1000 kWh \\
    \hline
    1 kW & 7 m$^2$ & vertical & 1000 kWh
  \end{roundtable}


\end{document}
